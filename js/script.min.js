const testData='[{"country":"Россия","cities":[{"city":"Красноярск","coordinates":[56.010569,92.852572],"objects":[{"name":"Офис КРАСНОЯРСК","manager":"Лягушкин Иван Сергеевич","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[56.014193,92.8588]},{"name":"Офис КРАСНОЯРСК ЦЕНТР","manager":"Зубенко Михаил Петрович","phoneNumbers":["+79992222222","+79992222222","+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[56.061124,92.968782]}]},{"city":"Норильск","coordinates":[69.357041,88.186171],"objects":[{"name":"Офис Норильск 8","manager":"Калугина Ева Владиславовна","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[69.343989,88.213558]},{"name":"Офис Норильск Главный","manager":"Петров Арсений Михайлович","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[69.340358,88.22605]}]},{"city":"Москва","coordinates":[55.7522,37.6156],"objects":[{"name":"Офис Москва","manager":"Кудряшов Алексей Георгиевич","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[55.756113,37.59536]},{"name":"Офис Москва 1","manager":"Сальникова Анна Львовна","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[55.631449,37.762387]},{"name":"Офис Москва 3","manager":"Павлова Любовь Ярославовна","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[55.800326,37.707938]}]},{"city":"Екатеринбург","coordinates":[56.8519,60.6122],"objects":[{"name":"Офис Екатеринбург 1","manager":"Зотов Илья Юрьевич","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[56.817075,60.543707]},{"name":"Офис Екатеринбург 2","manager":"Миронов Михаил Ильич","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[56.889012,60.608307]}]},{"city":"Владикавказ","coordinates":[43.0367,44.6678],"objects":[{"name":"офис Владикавказ","manager":"Муратов Руслан Александрович","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[43.053311,44.649789]}]}]},{"country":"Белоруссия","cities":[{"city":"Минск","coordinates":[53.9,27.5667],"objects":[{"name":"Офис МИНСК","manager":"Иванова Софья Марковна","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[53.899664,27.554764]},{"name":"Офис МИНСК ЦЕНТР","manager":"Зубкова Вероника Никитична","phoneNumbers":["+79992222222","+79992222222","+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[53.952568,27.615491]}]},{"city":"Брест","coordinates":[52.0975,23.6877],"objects":[{"name":"Офис БРЕСТ","manager":"Свешникова Эмилия Ивановна","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[52.092418,23.725233]}]},{"city":"Витебск","coordinates":[55.1904,30.2049],"objects":[{"name":"Офис ВИТЕБСК","manager":"Елисеев Иван Николаевич","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[55.173768,30.153316]},{"name":"Офис ВИТЕБСК 2","manager":"Тихомиров Савелий Никитич","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[55.196586,30.252575]}]},{"city":"Полоцк","coordinates":[55.4879,28.7856],"objects":[{"name":"Офис Полоцк 1","manager":"Макаров Максим Дмитриевич","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[55.485139,28.804243]},{"name":"Офис Полоцк 2","manager":"Петров Михаил Иванович","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[55.499229,28.753994]}]},{"city":"Светлогорск","coordinates":[52.6329,29.7389],"objects":[{"name":"Офис Светлогорск","manager":"Фомичев Станислав Иванович","phoneNumbers":["+79992222222","+79992222222"],"email":"username@flagstudio.ru","coordinates":[52.627032,29.731153]}]}]}]';function init(){const e=new ymaps.Map("map",{center:[56.01,92.85],zoom:6,controls:[]}),t=ymaps.templateLayoutFactory.createClass('<div class="popover top"><a class="close" href="#"></a><div class="arrow"></div><div class="popover-inner">$[[options.contentLayout observeSize minWidth=350 maxHeight=350 minHeight=150]]</div></div>',{build:function(){this.constructor.superclass.build.call(this),this._element=this.getParentElement().querySelector(".popover"),this._onCloseClick=this.onCloseClick.bind(this),this.applyElementOffset(),this._element.querySelector(".close").addEventListener("click",this._onCloseClick)},clear:function(){this._element.querySelector(".close").removeEventListener("click",this._onClickClick),this.constructor.superclass.clear.call(this)},onSublayoutSizeChange:function(){t.superclass.onSublayoutSizeChange.apply(this,arguments),this._isElement(this._element)&&(this.applyElementOffset(),this.events.fire("shapechange"))},applyElementOffset:function(){Object.assign(this._element.style,{left:-this._element.offsetWidth/2+"px",top:-(this._element.offsetHeight+this._element.querySelector(".arrow").offsetHeight)+"px"})},onCloseClick:function(e){e.preventDefault(),this.events.fire("userclose")},getShape:function(){if(!this._isElement(this._element))return t.superclass.getShape.call(this);const e=getComputedStyle(this._element),o={left:parseFloat(e.left),top:parseFloat(e.top)};return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[o.left,o.top],[o.left+this._element.offsetWidth,o.top+this._element.offsetHeight+this._element.querySelector(".arrow").offsetHeight]]))},_isElement:function(e){return e&&e.querySelector(".arrow")}}),o=ymaps.templateLayoutFactory.createClass('<div class="popover-content">$[properties.balloonContent]</div>'),n=ymaps.templateLayoutFactory.createClass(['<div class="cluster-balloon-offices">',"{% for geoObject in properties.geoObjects %}",'<details class="cluster-balloon-office"><summary class="cluster-balloon-office-number">{{geoObject.properties.balloonContentHeader|raw}}</summary>',"{{ geoObject.properties.balloonContent|raw }}","</details>","{% endfor %}","</div>"].join("")),a=JSON.parse(testData),s=[];for(let e=0;e<a.length;e++)s[e]=r(a[e],e);function r(a,s){let r=[],c=document.createElement("div");return c.className="country",c.id="country-"+s,c.innerHTML=a.country,c.onclick=function(t){m(t.target.id.replace("country-","")),e.setBounds(e.geoObjects.getBounds()),e.getZoom()>6&&e.setZoom(6)},function(a,s,r){if(!a)return;let c=document.createElement("div");c.className="country-data",c.id="countryData-"+s;for(let s=0;s<a.length;s++){const m=new ymaps.Clusterer({preset:"islands#invertedBlueClusterIcons",clusterIcons:[{href:"./img/placemark.svg",size:[40,40],offset:[-20,-20]}],groupByCoordinates:!1,clusterDisableClickZoom:!0,clusterHideIconOnBalloonOpen:!1,geoObjectHideIconOnBalloonOpen:!1,balloonLayout:t,balloonContentLayout:o,clusterBalloonContentLayout:n,balloonOffset:[110,5],balloonHeader:"s"});m.events.add("click",function(t){const o=t.get("target");e.setCenter(o.geometry.getBounds()[0]),void 0===o.getGeoObjects&&e.getZoom()<12&&e.setZoom(12)});let u=document.createElement("details");u.className="city",u.innerHTML=`<summary class="city-name">${a[s].city}</summary>`,u.append(i(a[s].objects,m)),u.addEventListener("toggle",e=>l(e,m,a[s])),u.onclick=function(){},c.append(u),r[s]=m}document.querySelector(".sidebar").append(c)}(a.cities,s,r),document.querySelector(".countries").append(c),r}function l(t,o,n){t.target.open?(n.coordinates?e.setCenter(n.coordinates,6):(e.setCenter([63,92],5),console.log(0===o.getClusters().length)),0!==o.getClusters().length?(o.balloon.open(o.getClusters()[0]),e.setCenter(o.getClusters()[0].geometry.getBounds()[0],6)):(e.setCenter(o.getGeoObjects()[0].geometry.getBounds()[0],6),e.getZoom()<12&&e.setZoom(12),o.getGeoObjects()[0].balloon.open(o.getGeoObjects()[0])),document.querySelectorAll(".country-data > details[open]").forEach(e=>{e!==t.target&&(e.open=!1)})):0!==o.getClusters().length?o.balloon.close(o.getClusters()[0]):o.getGeoObjects()[0].balloon.close(o.getGeoObjects()[0])}function i(e,n){let a=document.createElement("ul");a.className="offices-list";for(let s=0;s<e.length;s++){let r=document.createElement("li");if(r.className="office",c(r,e[s].name,`<div class="office-name">${e[s].name}</div>`),c(r,e[s].manager,`<div class="manager-name">${e[s].manager}</div>`),e[s].phoneNumbers&&0!==e[s].phoneNumbers.length){let t='<div class="phone-numbers">',o=/(\+7|8)[\s(]?(\d{3})[\s)]?(\d{3})[\s-]?(\d{2})[\s-]?(\d{2})/g;for(let n of e[s].phoneNumbers)t+=`<a class="phone" href="tel:${n}">${n.replace(o,"+7($2) $3-$4-$5")}</a>`;t+="</div>",r.insertAdjacentHTML("beforeend",t)}if(c(r,e[s].email,`<a class="email" href="mailto:${e[s].email}">${e[s].email}</a>`),a.append(r),e[s].coordinates){const a=new ymaps.Placemark(e[s].coordinates,{balloonContent:r.outerHTML,balloonContentHeader:"Офис №"+(Number(s)+1)},{iconLayout:"default#image",iconImageHref:"./img/placemark.svg",iconImageSize:[20,20],iconImageOffset:[-10,-10],balloonShadow:!1,balloonLayout:t,balloonContentLayout:o,balloonPanelMaxMapArea:0,hideIconOnBalloonOpen:!1,balloonOffset:[110,5]});n.add(a)}}return a}function c(e,t,o){t&&0!==t.length&&e.insertAdjacentHTML("beforeend",o)}function m(t){let o=document.getElementById("country-"+t),n=document.getElementById("countryData-"+t);o.classList.contains("active")||(!function(){const t=document.querySelectorAll(".country"),o=document.querySelectorAll(".country-data");for(let e=0;e<t.length;e++)t[e].classList.remove("active"),void 0!==o[e]&&o[e].classList.remove("active");e.geoObjects.removeAll()}(),s[t].map(t=>{e.geoObjects.add(t)}),o.classList.add("active"),n&&n.classList.add("active"))}m(0),e.setBounds(e.geoObjects.getBounds())}ymaps.ready(init);